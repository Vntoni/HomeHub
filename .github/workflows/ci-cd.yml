name: CI/CD – Test & Deploy to RPi5

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ────────────────────────────────────────────
  # JOB 1 – testy (GitHub cloud runner)
  # ────────────────────────────────────────────
  test:
    name: Run pytest
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install system Qt/GL libs (headless)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            libegl1 libgl1-mesa-dev libglib2.0-0 \
            xvfb libxcb-cursor0

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Run tests (headless Qt)
        env:
          QT_QPA_PLATFORM: offscreen
        run: pytest Tests/ --cov=App --cov=Adapters --cov=Ports --cov-report=term-missing

  # ────────────────────────────────────────────
  # JOB 2 – build + deploy na RPi5
  # Działa jako self-hosted runner NA RPi5:
  # - ten sam ARM64 CPU → PyInstaller działa
  # - RPi5 łączy się z GitHub (wychodzące) → nie trzeba otwierać portów
  # ────────────────────────────────────────────
  deploy:
    name: Build & Deploy on RPi5
    runs-on: self-hosted
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout latest code
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          ~/.virtualenvs/Baza_Domowa/bin/pip install -r requirements.txt --quiet

      - name: Build with PyInstaller
        run: |
          ~/.virtualenvs/Baza_Domowa/bin/python build_app.py

      - name: Stop app service before replacing binary
        run: systemctl --user stop bazadomowa || true

      - name: Replace binary
        run: |
          rm -rf ~/app/BazaDomowa
          cp -r dist/BazaDomowa ~/app/BazaDomowa
          chmod +x ~/app/BazaDomowa/BazaDomowa

      - name: Start app service
        run: |
          systemctl --user start bazadomowa
          systemctl --user status bazadomowa --no-pager
